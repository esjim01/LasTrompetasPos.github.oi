<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - Las Trompetas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="public/css/styles.css"> 
</head>

<body class="login-body">

    <div class="card login-card">
        <div class="card-content">
            
            <div class="logo-container">
                <img src="img/Las_trompetas.jpg" alt="Logo" onerror="this.src='https://via.placeholder.com/150/e8eaf6/3949ab?text=LT'">
                <h5 style="color:var(--primary-color); font-weight:700;">Las Trompetas</h5>
                <p style="color:#90a4ae;">Acceso Administrativo</p>
            </div>

            <div class="input-field">
                <i class="material-icons prefix">person_outline</i>
                <input type="text" id="user" autocomplete="username">
                <label for="user">Usuario</label>
            </div>

            <div class="input-field">
                <i class="material-icons prefix">lock_outline</i>
                <input type="password" id="pass" autocomplete="current-password">
                <label for="pass">Contraseña</label>
            </div>

            <button class="btn btn-login waves-effect waves-light" id="btn-entrar" onclick="iniciarSesion()">
                Ingresar al Sistema
            </button>

            <div class="loading-overlay" id="loader" style="display:none; margin-top:15px;">
                <div class="progress">
                    <div class="indeterminate"></div>
                </div>
            </div>

            <div class="login-footer" style="text-align:center; margin-top:20px; color:#ccc; font-size:0.8rem;">
                &copy; 2026 Sistema de Gestión
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        // --- LÓGICA DE LOGIN ---
        async function iniciarSesion() {
            const user = document.getElementById("user").value.trim();
            const pass = document.getElementById("pass").value.trim();
            const btn = document.getElementById("btn-entrar");
            const loader = document.getElementById("loader");

            if (!user || !pass) return M.toast({html: 'Por favor, completa los datos', classes: 'rounded orange darken-2'});

            // Bloquear botón y mostrar carga
            btn.disabled = true;
            btn.innerText = 'Verificando...';
            loader.style.display = "block";

            try {
                // Petición al Backend
                const res = await fetch("/api/index", { // Verificamos que esta ruta sea la correcta en tu servidor
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user, pass }),
                });

                const data = await res.json();

                if (res.ok) {
                    // --- GUARDADO DE SESIÓN SEGURO (CRÍTICO) ---
                    // Creamos un objeto limpio con los datos
                    const usuarioData = { 
                        nombre: data.user, 
                        rol: data.rol 
                    };

                    // Guardamos en formato JSON string para que dashboard.js lo pueda leer bien
                    localStorage.setItem("usuarioNombre", JSON.stringify(usuarioData));
                    
                    // Guardamos una copia extra por seguridad
                    localStorage.setItem("usuarioActual", JSON.stringify(usuarioData));

                    M.toast({html: '¡Bienvenido!', classes: 'rounded green darken-1'});
                    
                    // Redirección basada en rol
                    setTimeout(() => {
                        const rol = (data.rol || "").toUpperCase();
                        if (rol === "ADMIN" || rol === "ADMINISTRADOR" || rol === "JEFE") {
                            window.location.href = "public/dashboard.html"; // Asegúrate que la carpeta public esté en la URL
                        } else {
                            window.location.href = "public/ventas.html";
                        }
                    }, 800);

                } else {
                    M.toast({html: data.mensaje || 'Credenciales incorrectas', classes: 'rounded red darken-2'});
                    resetBtn();
                }
            } catch (error) {
                console.error("Error en login:", error);
                M.toast({html: 'Error de conexión con el servidor', classes: 'rounded red darken-4'});
                resetBtn();
            }

            function resetBtn() {
                btn.disabled = false;
                btn.innerText = 'Ingresar al Sistema';
                loader.style.display = "none";
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Permitir Login con tecla Enter
            document.getElementById('pass').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') iniciarSesion();
            });
            // Inicializar inputs de Materialize
            M.updateTextFields();
        });
    </script>
</body>
</html>